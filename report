indice nao esta sen do acrescido apos cenario de erro - verificar condição de add
    indice acrescido em caso de erro na aedição da nota mas nao na impressao - 
tempo de excecução insuficiente - gerando erro no salvamento/cancelamento da nota - [ok]
verificar avaliação de cep para cfop - adicionar log que devolve o cfop p cep[ok]

se nota salva mas impressao nao acontece:   
    desmarca checkbox mas volta a editar a mesma nota fiscal - adicionar indice e descartar nota#
        se tenta imprimir e se torna consultar situação, acontece 2x o desmarcar checkbox,
        e a nota é carregada pra frente - checar a função de desmarcar checkbox

    nf nao processada se torna esperando processamento

    entao:
    se der erro, apotar index +1 antes de repetir o looping
    usar caso exception e


E-mail: financeiro@goiaspet.com.br
Senha: gp-matriz_s2-BLg






12/09/2024
    review logico do script:
    // driver init [ok]
    // select nf - recall driver e gera index [apontar index update corretamente]
        detecta index variavel pelo xpath
    // determina cfop[ok]
    // desmacar checkbox[corrigir mal funcionamento]
        desmarca checkbox do indice atual da nota definido pelo xpath
        clica checkbox indice atual
        --- erro nao nitido na função, possivelmente na chamada dela---
    // clicar no item [nome função burro - explicitar melhor que clica no item dentro da lista criada pa itens na nota]
    // processar itens nota[ok]
        repara que dentro dos itens chama driver e cfop - verificar logica para chamar index em caso de erro se preciso
        chama dentro da função // clicar no item
        chama //processar item - verificar consistencia dessa função com cuidado
    //processar item (driver, cfop, itemxpath - possivel add index)
        sem erros explicitos nas etapas de processamento da nota
        adicionar esperas implicitas e expplicitas para melhorar desempenho - foco cliques & botoes
        EXCEPT PARA TRATAR CASO DE EXCESSAO DAS ETAPAS DO PROCESSAMENTO
            except sem nenhuma condição específica, basta erro
            enteder o que é o exception as {e} <----------------
            substituir todo o tratamento pelas funcoes responsaveis por cancelamento e desmarcar checkbox
                salvar alteracao item nota
                cancelar processamento nota
                desmarcar checkboix nota
                index +1 
                restart process
    //processar nota fiscal [!!!!!!!!!!!! comparar redundancia e necessidade frente a função anterior]
        possivel juntar junto com a função anterior<-----------------------
        chama //selecionar nf
        chama a coleta do cep p cfop de fato
            avaliar a possibilidade de tirar a captura do cep do topo
        chama //processar itens nota(executa de fato todas as alterações do item da nota e aponta p caso de excessão[verificar saída p excessão])
        efetua de fato o salvamento das alteracoes na nota em si
        verifica se houve erro no salvamento da nota
        se teve erro no salvemento - verificar erro salvamento(driver):
        chama //cancelar processo(driver)
        chama //desmarcar checkbox(driver, index)
        return TRUE, index +1 <---- se a função verifricar erro for chamada(True) entao cancela, desmarca, index+1<--------- VERIFICAR FUN ERRO
        se n, chama //emitir nf(driver , index)
        False p função erro, index retorna(atual)
    //emitir_nota_fiscal(driver, index--n ta em uso ver motivo)
        envia nota por aquele botao
        espera até 40 sec, n é pra dar erro aqui
        time sleep 2.5(melhorar logica com espera explicita ou implicita p tirar esse timer)
        manda nota impressao 
        chama outro TRY <--- melhore esta parte

    //verificar_erro_salvamento(driver)
        analisa mensagem de erro apos tentar salvar a nota fiscal
        
    //cancelar_processo
        aperta botao cancelar nota <-- verificar qual botao estamos apertando novamente
    //exixtem mais notas fiscais(driver)
        atualmente verifica primera nf, aponntar para proxima nf

    //////////main///////////
    inicia driver
        se driver iniciado
            pega site notas
            sucesso em 0
            erro em 0
            index começa em 1
            enquanto driver ativo
                verifica se existem mais notas(configurado pra checar a primeira nf)
                quebralaço se verificar e n achar
                atualmente so quebra o laço se sair da pg
            se der erro(deve ter ligação com exception e)<----------
                erro count =+1
            se n:
            sucesso =+1
            exception {e}:
            retorna qual nota deu errado
            erro =+1
            index += 1
        print a contagem erro acerto
        




    PS C:\Users\Lucas\Documents\automacaonotas> & C:/Users/Lucas/AppData/Local/Programs/Python/Python312/python.exe "c:/Users/Lucas/Documents/automacaonotas/9225 copy 2.py"
Iniciando o driver do Chrome...
Driver iniciado com sucesso.
deu certo
deu certo
status da nota fiscal atual:Pendente

Tentando selecionar a checkbox 1...
Checkbox selecionada com sucesso.
Campo associado selecionado com sucesso.
status da nota fiscal atual:

Iniciando a captura do CEP...
46430
Valor de CFOP determinado: 6108
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 23297493773
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 23297493773
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1]
Item não encontrado ou não clicável: Message: javascript error: {"status":60,"value":"[object HTMLTableCellElement] has no size and location"}
  (Session info: chrome=129.0.6668.70)
Stacktrace:
        GetHandleVerifier [0x00007FF6307AB125+29573]
        (No symbol) [0x00007FF63071FF50]
        (No symbol) [0x00007FF6305DB6EA]
        (No symbol) [0x00007FF6305E22BE]
        (No symbol) [0x00007FF6305E4637]
        (No symbol) [0x00007FF6305E46F0]
        (No symbol) [0x00007FF6306368E3]
        (No symbol) [0x00007FF630635B66]
        (No symbol) [0x00007FF63068283A]
        (No symbol) [0x00007FF6306572FA]
        (No symbol) [0x00007FF6306786BC]
        (No symbol) [0x00007FF6306570A3]
        (No symbol) [0x00007FF6306212DF]
        (No symbol) [0x00007FF630622441]
        GetHandleVerifier [0x00007FF630ADC76D+3377613]
        GetHandleVerifier [0x00007FF630B27B67+3685831]
        GetHandleVerifier [0x00007FF630B1CF8B+3641835]
        GetHandleVerifier [0x00007FF63086B2A6+816390]
        (No symbol) [0x00007FF63072B25F]
        (No symbol) [0x00007FF630727084]
        (No symbol) [0x00007FF630727220]
        (No symbol) [0x00007FF63071607F]
        BaseThreadInitThunk [0x00007FFDF9517374+20]
        RtlUserThreadStart [0x00007FFDF9B5CC91+33]

Tentando salvar as alterações na nota...
Alterações na nota salvas com sucesso.
deu certo
Verificando mensagem de erro após salvar a nota...
Não foi possível salvar a Nota Fiscal
Mensagem de erro detectada: Não foi possível salvar a Nota Fiscal
Problema com o item 1 - 1 x BIO HALIT'Z GOTAS 6ML: situação tributária do COFINS deve(m) ser preenchido(s).
Erro encontrado, mas não é específico do município.
Erro detectado após salvar a nota.
Tentando cancelar o processo...
Processo cancelado.
Desmarcando a checkbox 1...
Checkbox 1 desmarcada.
deu certo
status da nota fiscal atual:Pendente

Tentando selecionar a checkbox 2...
Checkbox selecionada com sucesso.
Campo associado selecionado com sucesso.
status da nota fiscal atual:

Iniciando a captura do CEP...
82600
Valor de CFOP determinado: 6108
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 23797736342
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 23797736342
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1]
Item não encontrado ou não clicável: Message: javascript error: {"status":60,"value":"[object HTMLTableCellElement] has no size and location"}
  (Session info: chrome=129.0.6668.70)
Stacktrace:
        GetHandleVerifier [0x00007FF6307AB125+29573]
        (No symbol) [0x00007FF63071FF50]
        (No symbol) [0x00007FF6305DB6EA]
        (No symbol) [0x00007FF6305E22BE]
        (No symbol) [0x00007FF6305E4637]
        (No symbol) [0x00007FF6305E46F0]
        (No symbol) [0x00007FF6306368E3]
        (No symbol) [0x00007FF630635B66]
        (No symbol) [0x00007FF63068283A]
        (No symbol) [0x00007FF6306572FA]
        (No symbol) [0x00007FF6306786BC]
        (No symbol) [0x00007FF6306570A3]
        (No symbol) [0x00007FF6306212DF]
        (No symbol) [0x00007FF630622441]
        GetHandleVerifier [0x00007FF630ADC76D+3377613]
        GetHandleVerifier [0x00007FF630B27B67+3685831]
        GetHandleVerifier [0x00007FF630B1CF8B+3641835]
        GetHandleVerifier [0x00007FF63086B2A6+816390]
        (No symbol) [0x00007FF63072B25F]
        (No symbol) [0x00007FF630727084]
        (No symbol) [0x00007FF630727220]
        (No symbol) [0x00007FF63071607F]
        BaseThreadInitThunk [0x00007FFDF9517374+20]
        RtlUserThreadStart [0x00007FFDF9B5CC91+33]

Tentando salvar as alterações na nota...
Alterações na nota salvas com sucesso.
deu certo
Verificando mensagem de erro após salvar a nota...
Não foi possível salvar a Nota Fiscal
Mensagem de erro detectada: Não foi possível salvar a Nota Fiscal
Problema com o item 1 - 1 x PREMIER COOKIE CÃES AD. 250G: situação tributária do PIS e a situação tributária do COFINS deve(m) ser preenchido(s).
Erro encontrado, mas não é específico do município.
Erro detectado após salvar a nota.
Tentando cancelar o processo...
Processo cancelado.
Desmarcando a checkbox 2...
Checkbox 2 desmarcada.
deu certo
status da nota fiscal atual:Rejeitada

status da nota fiscal atual:Rejeitada

Iniciando a captura do CEP...
Ocorreu um erro ao processar a nota fiscal 3: invalid literal for int() with base 10: ''
deu certo
status da nota fiscal atual:Pendente

Tentando selecionar a checkbox 4...
Checkbox selecionada com sucesso.
Campo associado selecionado com sucesso.
status da nota fiscal atual:

Iniciando a captura do CEP...
26011
Valor de CFOP determinado: 6108
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 23297493773
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 23297493773
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1]
Item não encontrado ou não clicável: Message: javascript error: {"status":60,"value":"[object HTMLTableCellElement] has no size and location"}
  (Session info: chrome=129.0.6668.70)
Stacktrace:
        GetHandleVerifier [0x00007FF6307AB125+29573]
        (No symbol) [0x00007FF63071FF50]
        (No symbol) [0x00007FF6305DB6EA]
        (No symbol) [0x00007FF6305E22BE]
        (No symbol) [0x00007FF6305E4637]
        (No symbol) [0x00007FF6305E46F0]
        (No symbol) [0x00007FF6306368E3]
        (No symbol) [0x00007FF630635B66]
        (No symbol) [0x00007FF63068283A]
        (No symbol) [0x00007FF6306572FA]
        (No symbol) [0x00007FF6306786BC]
        (No symbol) [0x00007FF6306570A3]
        (No symbol) [0x00007FF6306212DF]
        (No symbol) [0x00007FF630622441]
        GetHandleVerifier [0x00007FF630ADC76D+3377613]
        GetHandleVerifier [0x00007FF630B27B67+3685831]
        GetHandleVerifier [0x00007FF630B1CF8B+3641835]
        GetHandleVerifier [0x00007FF63086B2A6+816390]
        (No symbol) [0x00007FF63072B25F]
        (No symbol) [0x00007FF630727084]
        (No symbol) [0x00007FF630727220]
        (No symbol) [0x00007FF63071607F]
        BaseThreadInitThunk [0x00007FFDF9517374+20]
        RtlUserThreadStart [0x00007FFDF9B5CC91+33]

Tentando salvar as alterações na nota...
Alterações na nota salvas com sucesso.
deu certo
Verificando mensagem de erro após salvar a nota...
Não foi possível salvar a Nota Fiscal
Mensagem de erro detectada: Não foi possível salvar a Nota Fiscal
Problema com o item 1 - 1 x BIO HALIT'Z GOTAS 6ML: situação tributária do COFINS deve(m) ser preenchido(s).
Erro encontrado, mas não é específico do município.
Erro detectado após salvar a nota.
Tentando cancelar o processo...
Processo cancelado.
Desmarcando a checkbox 4...
Checkbox 4 desmarcada.
deu certo
status da nota fiscal atual:Pendente

Tentando selecionar a checkbox 5...
Checkbox selecionada com sucesso.
Campo associado selecionado com sucesso.
status da nota fiscal atual:

Iniciando a captura do CEP...
79021
Valor de CFOP determinado: 6108
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Item não encontrado ou não clicável: Message: javascript error: {"status":60,"value":"[object HTMLTableCellElement] has no size and location"}
  (Session info: chrome=129.0.6668.70)
Stacktrace:
        GetHandleVerifier [0x00007FF6307AB125+29573]
        (No symbol) [0x00007FF63071FF50]
        (No symbol) [0x00007FF6305DB6EA]
        (No symbol) [0x00007FF6305E22BE]
        (No symbol) [0x00007FF6305E4637]
        (No symbol) [0x00007FF6305E46F0]
        (No symbol) [0x00007FF6306368E3]
        (No symbol) [0x00007FF630635B66]
        (No symbol) [0x00007FF63068283A]
        (No symbol) [0x00007FF6306572FA]
        (No symbol) [0x00007FF6306786BC]
        (No symbol) [0x00007FF6306570A3]
        (No symbol) [0x00007FF6306212DF]
        (No symbol) [0x00007FF630622441]
        GetHandleVerifier [0x00007FF630ADC76D+3377613]
        GetHandleVerifier [0x00007FF630B27B67+3685831]
        GetHandleVerifier [0x00007FF630B1CF8B+3641835]
        GetHandleVerifier [0x00007FF63086B2A6+816390]
        (No symbol) [0x00007FF63072B25F]
        (No symbol) [0x00007FF630727084]
        (No symbol) [0x00007FF630727220]
        (No symbol) [0x00007FF63071607F]
        BaseThreadInitThunk [0x00007FFDF9517374+20]
        RtlUserThreadStart [0x00007FFDF9B5CC91+33]

Tentando salvar as alterações na nota...
Alterações na nota salvas com sucesso.
deu certo
Verificando mensagem de erro após salvar a nota...
Não foi possível salvar a Nota Fiscal
Mensagem de erro detectada: Não foi possível salvar a Nota Fiscal
É necessário informar pelo menos um item
Erro encontrado, mas não é específico do município.
Erro detectado após salvar a nota.
Tentando cancelar o processo...
Processo cancelado.
Desmarcando a checkbox 5...
Checkbox 5 desmarcada.
deu certo
status da nota fiscal atual:Pendente

Tentando selecionar a checkbox 6...
Checkbox selecionada com sucesso.
Campo associado selecionado com sucesso.
status da nota fiscal atual:

Iniciando a captura do CEP...
21740
Valor de CFOP determinado: 6108
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 22592365628
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 22592365628
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 23297746515
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 23297746515
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[3]/td[1]
Item não encontrado ou não clicável: Message: javascript error: {"status":60,"value":"[object HTMLTableCellElement] has no size and location"}
  (Session info: chrome=129.0.6668.70)
Stacktrace:
        GetHandleVerifier [0x00007FF6307AB125+29573]
        (No symbol) [0x00007FF63071FF50]
        (No symbol) [0x00007FF6305DB6EA]
        (No symbol) [0x00007FF6305E22BE]
        (No symbol) [0x00007FF6305E4637]
        (No symbol) [0x00007FF6305E46F0]
        (No symbol) [0x00007FF6306368E3]
        (No symbol) [0x00007FF630635B66]
        (No symbol) [0x00007FF63068283A]
        (No symbol) [0x00007FF6306572FA]
        (No symbol) [0x00007FF6306786BC]
        (No symbol) [0x00007FF6306570A3]
        (No symbol) [0x00007FF6306212DF]
        (No symbol) [0x00007FF630622441]
        GetHandleVerifier [0x00007FF630ADC76D+3377613]
        GetHandleVerifier [0x00007FF630B27B67+3685831]
        GetHandleVerifier [0x00007FF630B1CF8B+3641835]
        GetHandleVerifier [0x00007FF63086B2A6+816390]
        (No symbol) [0x00007FF63072B25F]
        (No symbol) [0x00007FF630727084]
        (No symbol) [0x00007FF630727220]
        (No symbol) [0x00007FF63071607F]
        BaseThreadInitThunk [0x00007FFDF9517374+20]
        RtlUserThreadStart [0x00007FFDF9B5CC91+33]

Tentando salvar as alterações na nota...
Alterações na nota salvas com sucesso.
deu certo
Verificando mensagem de erro após salvar a nota...
Não foi possível salvar a Nota Fiscal
Mensagem de erro detectada: Não foi possível salvar a Nota Fiscal
Problema com o item 2 - 1 x PREMIER COOKIE CÃES AD. RAÇAS PEQUENAS 250G: situação tributária do PIS e a situação tributária do COFINS deve(m) ser preenchido(s).
Erro encontrado, mas não é específico do município.
Erro detectado após salvar a nota.
Tentando cancelar o processo...
Processo cancelado.
Desmarcando a checkbox 6...
Checkbox 6 desmarcada.
deu certo
status da nota fiscal atual:Pendente

Tentando selecionar a checkbox 7...
Checkbox selecionada com sucesso.
Campo associado selecionado com sucesso.
status da nota fiscal atual:

Iniciando a captura do CEP...
Ocorreu um erro ao processar a nota fiscal 7: invalid literal for int() with base 10: ''
deu certo
status da nota fiscal atual:

status da nota fiscal atual:

Iniciando a captura do CEP...
Ocorreu um erro ao processar a nota fiscal 8: invalid literal for int() with base 10: ''
deu certo
status da nota fiscal atual:

status da nota fiscal atual:

Iniciando a captura do CEP...
25900
Valor de CFOP determinado: 6108
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 17338785962
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 17338785962
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 22392157730
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 22392157730
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[3]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[3]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[3]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[3]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 23792161743
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 23792161743
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[4]/td[1]
Executando clicar_no_item com XPath: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[4]/td[1]
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[4]/td[1] está clicável.
Elemento com XPath /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[4]/td[1] clicado com ActionChains.
selecionando o produto dentro da lista de 10...
Desconto apagado.
Campo de origem encontrado.
Texto copiado: 23797736342
Campo de destino encontrado.
Texto colado no elemento com ID /html/body/div[28]/form/div/div/div/div[1]/div[1]/input[2]: 23797736342
Pressionando Enter
Valor 6108 colado no campo CFOP.
Tentando salvar as alterações no item da nota...
Alterações no item da nota salvas com sucesso.
deu certo
Item encontrado: /html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[5]/td[1]
Item não encontrado ou não clicável: Message: javascript error: {"status":60,"value":"[object HTMLTableCellElement] has no size and location"}
  (Session info: chrome=129.0.6668.70)
Stacktrace:
        GetHandleVerifier [0x00007FF6307AB125+29573]
        (No symbol) [0x00007FF63071FF50]
        (No symbol) [0x00007FF6305DB6EA]
        (No symbol) [0x00007FF6305E22BE]
        (No symbol) [0x00007FF6305E4637]
        (No symbol) [0x00007FF6305E46F0]
        (No symbol) [0x00007FF6306368E3]
        (No symbol) [0x00007FF630635B66]
        (No symbol) [0x00007FF63068283A]
        (No symbol) [0x00007FF6306572FA]
        (No symbol) [0x00007FF6306786BC]
        (No symbol) [0x00007FF6306570A3]
        (No symbol) [0x00007FF6306212DF]
        (No symbol) [0x00007FF630622441]
        GetHandleVerifier [0x00007FF630ADC76D+3377613]
        GetHandleVerifier [0x00007FF630B27B67+3685831]
        GetHandleVerifier [0x00007FF630B1CF8B+3641835]
        GetHandleVerifier [0x00007FF63086B2A6+816390]
        (No symbol) [0x00007FF63072B25F]
        (No symbol) [0x00007FF630727084]
        (No symbol) [0x00007FF630727220]
        (No symbol) [0x00007FF63071607F]
        BaseThreadInitThunk [0x00007FFDF9517374+20]
        RtlUserThreadStart [0x00007FFDF9B5CC91+33]

Tentando salvar as alterações na nota...
Alterações na nota salvas com sucesso.
deu certo
Verificando mensagem de erro após salvar a nota...
Não foi possível salvar a Nota Fiscal
Mensagem de erro detectada: Não foi possível salvar a Nota Fiscal
Problema com o item 4 - 1 x PREMIER COOKIE CÃES AD. 250G: situação tributária do PIS e a situação tributária do COFINS deve(m) ser preenchido(s).
Erro encontrado, mas não é específico do município.
Erro detectado após salvar a nota.
Tentando cancelar o processo...
Processo cancelado.
Desmarcando a checkbox 9...
Checkbox 9 desmarcada.
deu certo
status da nota fiscal atual:Rejeitada

status da nota fiscal atual:Rejeitada

Iniciando a captura do CEP...
Ocorreu um erro ao processar a nota fiscal 10: invalid literal for int() with base 10: ''
deu certo
status da nota fiscal atual:Rejeitada

status da nota fiscal atual:Rejeitada

Iniciando a captura do CEP...
Ocorreu um erro ao processar a nota fiscal 11: invalid literal for int() with base 10: ''
deu certo
status da nota fiscal atual:Pendente

Tentando selecionar a checkbox 12...
Checkbox selecionada com sucesso.
Campo associado selecionado com sucesso.
status da nota fiscal atual:

Iniciando a captura do CEP...
32672
Valor de CFOP determinado: 6108
deu certo


lista_exceptions=[ConnectTimeout, requests.Timeout, requestions.connectionError, requests.exceptions.ConnectTimeout, InterruptedError
TimeoutError]


from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.common.keys import Keys
import pandas as pd
import time
import requests

def iniciar_driver():
    try:
        print("Iniciando o driver do Chrome...")
        chrome_options = Options()
        chrome_options.add_experimental_option("debuggerAddress", "127.0.0.1:9222")
        driver = webdriver.Chrome(options=chrome_options)
        print("Driver iniciado com sucesso.")
        return driver
    except Exception as e:
        print(f"Erro ao iniciar o driver do Chrome: {e}")
        return None

lista_erros = []
#def contador_erros(driver):
    
def check_internet (url="http://www.google.com", timeout=10):#avaliar
    try:
        #mandar teste no link do google
        resposta = requests.get(url, timeout=timeout)
        #se der resposta 200, ta tudo certo
        if resposta.status_code == 200:
            print(f'CONECTADO', end='')
            print('*'*30)
            return True 
        else:
            print(f'DESCONECTADO')
            print('#'*30)
            return False
        
    except requests.ConnectionError:
        #se der errado, vamo considerar que n tem
        
        return False

def selecionar_checkbox_e_campo(driver, index):

    try:

        global campo_situacao_xpath
        global campo_situacao
        global status_campo_situacao

        campo_situacao_xpath = f'/html/body/div[6]/div[8]/div[2]/div[7]/table/tbody/tr[{index}]/td[5]/span[2]/span'
        campo_situacao = WebDriverWait(driver, 50).until(
            EC.presence_of_element_located((By.XPATH, campo_situacao_xpath)))
        status_campo_situacao = campo_situacao.text
        
        #print(f"Tentando selecionar a checkbox {index}...")

        try:
            print(f'status da nota fiscal atual:{status_campo_situacao}''\n')
        
            if  status_campo_situacao != "Pendente":
                return False, index + 1
            else: 
                time.sleep(3)
                print(f"Tentando selecionar a checkbox {index}...")
                checkbox_xpath = f'/html/body/div[6]/div[8]/div[2]/div[7]/table/tbody/tr[{index}]/td[1]/div/label'
                campo_xpath = f'/html/body/div[6]/div[8]/div[2]/div[7]/table/tbody/tr[{index}]/td[4]'
                checkbox = WebDriverWait(driver, 50).until(
                    EC.element_to_be_clickable((By.XPATH, checkbox_xpath))
                )
                actions = ActionChains(driver)
                actions.move_to_element(checkbox).click().perform()
                print("Checkbox selecionada com sucesso.")
                time.sleep(.5)
                campo = WebDriverWait(driver, 50).until(
                    EC.element_to_be_clickable((By.XPATH, campo_xpath))
                )
                actions.move_to_element(campo).click().perform()
                print("Campo associado selecionado com sucesso.")
                return True
        except Exception as e:
            print(f"Erro ao selecionar a checkbox ou campo: {e}")
            raise e
                
            
    except Exception as e:
        print(f"Erro ao selecionar a checkbox ou campo: {e}")
        raise e

def determinar_cfop(cep_text):
    time.sleep(2)
    cep_prefix = cep_text[:5]
    cep_num = int(cep_prefix.replace("-", ""))
    print(cep_num)
    if (72800 <= cep_num <= 72999) or (73700 <= cep_num <= 76799):
        return 5102
    else:
        return 6108

def desmarcar_checkbox_atual(driver, index):#redundancia mais p baixo no codigo
    try:
        print(f"Desmarcando a checkbox {index}...")
        checkbox_xpath = f'/html/body/div[6]/div[8]/div[2]/div[7]/table/tbody/tr[{index}]/td[1]/div/label'
        checkbox = WebDriverWait(driver, 50).until(
            EC.element_to_be_clickable((By.XPATH, checkbox_xpath))
        )
        actions = ActionChains(driver)
        actions.move_to_element(checkbox).click().perform()
        print(f"Checkbox {index} desmarcada.")
    except Exception as e:
        print(f"Erro ao desmarcar checkbox: {e}")
        #desmarca a checkbox com indice relativo ao que estamos tratando - contagem 1-1 para cada nf selecionada

def clicar_no_item(driver, xpath):#clica no item dentro da lista criada abaixo (1-10) para os possiveis itens da nota
    print(f"Executando clicar_no_item com XPath: {xpath}")
    
    try:
        elemento = WebDriverWait(driver, 50).until(
            EC.element_to_be_clickable((By.XPATH, xpath))
        )
        print(f"Elemento com XPath {xpath} está clicável.")
        #time.sleep(1)
        actions = ActionChains(driver)
        actions.move_to_element(elemento).click().perform()
        print(f"Elemento com XPath {xpath} clicado com ActionChains.")
    except Exception as e:
        print(f"Erro ao clicar no elemento com ActionChains: {e}")

def processar_itens_nota(driver, cfop):#detectar itens da nota fiscal
    #deslocar para itens
    # pepara para executar bloco de tratamento de item na nota
    item_xpaths = [
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[1]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[2]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[3]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[4]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[5]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[6]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[7]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[8]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[9]/td[1]',
        '/html/body/div[6]/div[2]/form/div/div/div[42]/table/tbody/tr[10]/td[1]',
#ajustado para processar até 10 itens que tiverem em uma nota
]

    for item_xpath in item_xpaths:#para cada item na lista de itens
        try:
            item_element = WebDriverWait(driver, 50).until(#item localizado e selecionado dentro da lista criada anteriormente
                EC.presence_of_element_located((By.XPATH, item_xpath))
            )
            print(f"Item encontrado: {item_xpath}")
            
            # Rolar a página para 30% acima da posição do elemento
            driver.execute_script("window.scrollBy(0, arguments[0].getBoundingClientRect().top - window.innerHeight * 0.3);", item_element)
            time.sleep(1)  # Espera um curto período para garantir que a rolagem seja concluída
            
            # Usar ActionChains para garantir que o elemento esteja visível e interagível
            actions = ActionChains(driver)#tirar achtion chains - clique muito lento
            actions.move_to_element(item_element).perform()
            time.sleep(1)  # Espera um curto período para garantir que o movimento seja concluído

            clicar_no_item(driver, item_xpath)
            #função clique no item chamada recursivamente - replicar para outros blocos que preciso acionar
            
            # Processar o item
            processar_item(driver, cfop, item_xpath)#chamada recursivamente - identação/função definida posteriormente
        except Exception as e:
            print(f"Item não encontrado ou não clicável: {e}")
            break  # Se um item não for encontrado, sai do loop e continua o processamento

'''def situacao_nf(driver):
    global campo_situacao_xpath
    global campo_situacao
    global status_campo_situacao

    campo_situacao_xpath = '/html/body/div[6]/div[8]/div[2]/div[7]/table/tbody/tr/td[5]/span[2]/span'
    campo_situacao = WebDriverWait(driver, 50).until(
            EC.presence_of_element_located((By.XPATH, campo_situacao_xpath))).text
    print(status_campo_situacao)
    status_campo_situacao = campo_situacao.get_attribute("value")
    print(status_campo_situacao)'''

def processar_item(driver, cfop, item_xpath):#objetos(?) definido para uso 
    try:#executa as trasnformaçõe dentro dos itens da nota fiscal
        #selecionar item 

        print("selecionando o produto dentro da lista de 10...")
        #recursivamente garante o clique no item da nota - o item xpath é erança da função anterior
        novo_campo = driver.find_element(By.XPATH, item_xpath)#aciona o campo listado dentro de uma variavel nova -> novo_campo
        actions = ActionChains(driver)
        actions.move_to_element(novo_campo).click().perform()
        #time.sleep(1   

        # Apagar desconto
        campo_apagar_xpath = '//*[@id="edValorDescontoItem"]'#xpath do campo de desconto
        campo_apagar = WebDriverWait(driver, 50).until(#espera até 10 sec p campo ficar disponivel e clica
            EC.presence_of_element_located((By.XPATH, campo_apagar_xpath)))
        campo_apagar.clear()#apaga valor do campo
        print("Desconto apagado.")#log de retorno pra ação bem sucedida

        #copiar codigo origem item
        copiar_codigo_origem_xpath = '/html/body/div[29]/form/div/div/div/div[1]/div[2]/input'#xpath campo copiar codigo produto
        campo_origem = WebDriverWait(driver, 50).until(#espera até 10 sec campo ficar disponivel
            EC.presence_of_element_located((By.XPATH, copiar_codigo_origem_xpath)))
        print("Campo de origem encontrado.")#log return
        copiacodigo = campo_origem.get_attribute("value")#copia valor 
        print(f"Texto copiado: {copiacodigo}")#return valor copiado

        #define campo de destino do codigo do produto
        campo_destino_xpath = '/html/body/div[29]/form/div/div/div/div[1]/div[1]/input[2]'#xpath campo colar codigo produto
        campo_destino = WebDriverWait(driver, 50).until(#espera até 10 sec campo ficar disponivel
            EC.presence_of_element_located((By.XPATH, campo_destino_xpath)))
        print("Campo de destino encontrado.")#log return
        campo_destino.clear()#ação apagar valor
        campo_destino.send_keys(copiacodigo)#enviar valor do codigo copiado
        print(f"Texto colado no elemento com ID {campo_destino_xpath}: {copiacodigo}")#cola o codigo do produto dentro do item
        time.sleep(3)#espera 2 sec para nome do produto pelo codigo
        print('Pressionando Enter')#seleciona o item default relacionado ao codigo colado
        actions = ActionChains(driver)
        actions.send_keys(Keys.RETURN).perform()#aperta botao seleciona nome produto relacionado - codigo
        time.sleep(1)
        
        campo_cfop_xpath = '/html/body/div[29]/form/div/div/div/div[3]/div[9]/input'#define campo cfop para colar
        campo_cfop = WebDriverWait(driver, 50).until(#espera até 10 sec campo disponível
            EC.presence_of_element_located((By.XPATH, campo_cfop_xpath)))
        campo_cfop.clear()#apaga valor presente
        campo_cfop.send_keys(str(cfop))#envia valor armazenado variavel
        print(f"Valor {cfop} colado no campo CFOP.")#log return codigo
        # Salvar alterações no item da nota e permite passar pro prox o terminar a nota
        salvar_alteracoes_item(driver)#em caso de sucesso de todas etapas, executa função salvar_alterações_item(rever função sintaxe/lógica)

    except Exception as e:#excessao se nao conseguir executar algum dos passos de processamento da nota
        print(f"Erro ao processar o item: {e}")#retorna mensagem de erro
        
        cancelar_processo(driver)#primeiro salvar o item da nota
        salvar_alteracoes_item(driver)
        print("Alterações no item da nota salvas com sucesso.")#log return clicar botao salvar

        time.sleep(2)
        #cancela a emissao dessa nota
        print("cancelando processo emissão nota...")#log return cancelar emissao
        botao_cancelar_xpath = '/html/body/div[29]/div[2]/div/button'#define botao cancelar xpath
        botao_cancelar = WebDriverWait(driver, 50).until(#espera até 10 sec para pressionar botao
            EC.element_to_be_clickable((By.XPATH, botao_cancelar_xpath)))#EC - entender essa sintaxe
        actions = ActionChains(driver)#actionchains para selecionar de forma eficaz - buscar forma mais eficiente(tempo)
        actions.move_to_element(botao_cancelar).click().perform()#move cursor e pressiona botao
        print("Processo cancelado.")#log return processo cancelado
        #time sleep removido, foco n o webdriver wait
        #AVALIAR FUNÇÃO PARA CENARIO DE ERRO GERAL E VERIFICAR POSSIBILIDADE SUBSTITUIR TODO ESSA LOGICA DO BLOCO EXCEPT PELA FUNÇÃO JÁ CRIADA
        
def salvar_alteracoes_nota(driver):
    print("Tentando salvar as alterações na nota...")
    botao_salvar_nota_xpath = '/html/body/div[6]/div[2]/form/div/div/div[1]/div/div[3]/button'
    botao_salvar_nota = WebDriverWait(driver, 50).until(EC.element_to_be_clickable((By.XPATH, botao_salvar_nota_xpath)))
    actions = ActionChains(driver)
    actions.move_to_element(botao_salvar_nota).click().perform()
    print("Alterações na nota salvas com sucesso.")

def salvar_alteracoes_item(driver):
    try:
        time.sleep(1)
        print("Tentando salvar as alterações no item da nota...")
        botao_salvar_item_xpath = '/html/body/div[29]/div[2]/div/button'
        botao_salvar_item = WebDriverWait(driver, 50).until(
            EC.element_to_be_clickable((By.XPATH, botao_salvar_item_xpath))
        )
        actions = ActionChains(driver)
        actions.move_to_element(botao_salvar_item).click().perform()
        print("Alterações no item da nota salvas com sucesso.")
        time.sleep(1)
    except Exception as e:
        print(f"Erro ao salvar as alterações no item da nota: {e}")

def processar_nota_fiscal(driver, index):
    #define cfop e cep, salva nota e verifica erro
    #try:
        nota_selecionada = selecionar_checkbox_e_campo(driver, index)
        if nota_selecionada:
            selecionar_checkbox_e_campo(driver, index)
            #time.sleep(1)
            #da utilidade pra variavel do cep só aqui
            print("Iniciando a captura do CEP...")
            driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
            cep_xpath = '/html/body/div[6]/div[2]/form/div/div/div[30]/div/input'
            cep_field = WebDriverWait(driver, 50).until(
                EC.presence_of_element_located((By.XPATH, cep_xpath))
            )
            time.sleep(1)
            cep_text = cep_field.get_attribute("value")
            cfop = determinar_cfop(cep_text)
            print(f"Valor de CFOP determinado: {cfop}")
            #time.sleep(1)

            # Processar itens da nota fiscal
            processar_itens_nota(driver, cfop)

            salvar_alteracoes_nota(driver)
            time.sleep(1.5)

            if verificar_erro_salvamento(driver):
                print("Erro detectado após salvar a nota.")
                cancelar_processo(driver)
                desmarcar_checkbox_atual(driver, index)
                return True, index + 1
            else:
                emitir_nota_fiscal(driver, index)
                return False, index
            '''if verificar_erro_salvamento(driver):
                if funcao_erro_municipio(driver):
                    print('o script veio para cá - erro municipio')
                    emitir_nota_fiscal(driver, index)
                    #verificar_erro_salvamento(driver):
                    print('Erro de município persiste após tentativa de correção')
                    raise Exception('Erro não corrigido no município')
                    return False, index
                
                else:
                    print('o script veio para cá')
                    print("Erro detectado após salvar a nota.")
                    cancelar_processo(driver)
                    desmarcar_checkbox_atual(driver, index)
                    return True, index + 1
                    
                emitir_nota_fiscal(driver, index)
                    return False, index
                
                except:
                    print('o script veio para cá')
                    print("Erro detectado após salvar a nota.")
                    cancelar_processo(driver)
                    desmarcar_checkbox_atual(driver, index)
                    return True, index + 1
            else:
                print('script nao veio para nenhum caso de erro')
                salvar_alteracoes_nota(driver)
                emitir_nota_fiscal(driver, index)
                return False, index'''
        else:
            print('nota fiscal nao selecionada e pulada')
    #except Exception as e:
     #   print(f"Ocorreu um erro inesperado: {e}")
      #  cancelar_processo(driver)
       # desmarcar_checkbox_atual(driver, index)
        #return True, index + 1

def emitir_nota_fiscal(driver, index):
    print(f'o index atual é {index}')
    try:
        time.sleep(2.5)
        print("enviando nota salva p impressao")#botao de enviar nota
        botao_enviar_nota_xpath = '/html/body/div[6]/div[8]/div[3]/div[2]/div/div[1]/button[1]/span[2]'
        botao_enviar_nota = WebDriverWait(driver, 50).until(EC.element_to_be_clickable((By.XPATH, botao_enviar_nota_xpath)))
        actions = ActionChains(driver)
        actions.move_to_element(botao_enviar_nota).click().perform()
        print("Nota enviada com sucesso.")

    except Exception as e:
        print(f"Erro ao enviar a nota: {e}")

    try:
        time.sleep(2.5)
        print("Pressionar botao para imprimir a nota salva")
        botao_imprimir_nota_xpath = '/html/body/div[29]/div[3]/div/button'#enviar selecionado2
        botao_imprimir_nota = WebDriverWait(driver, 50).until(
            EC.element_to_be_clickable((By.XPATH, botao_imprimir_nota_xpath))
        )
        actions = ActionChains(driver)
        actions.move_to_element(botao_imprimir_nota).click().perform()
        print("Nota enviada para impressão.")
        time.sleep(1)
        #return False, index
    
    except Exception as e:
        print(f"Erro ao enviar a nota para impressão-: {e}")
        
    try:#check
        print('tentando bloco mensagem')
        time.sleep(4)
        print('verificar condição de encerramento')
            # Obtém o elemento e extrai o texto
        
        

        while True:  # Loop infinito até que a condição seja satisfeita
            mensagem_verificar_xpath = '/html/body/div[29]/div[2]/div[3]/div[2]/div/div[1]/div[1]/div'#aqui
            print(mensagem_verificar_xpath)
            #time.sleep(5)       
            WebDriverWait(driver, 50).until(EC.presence_of_element_located((By.XPATH, mensagem_verificar_xpath)))

            mensagem_verificar_element = WebDriverWait(driver, 50).until(EC.presence_of_element_located((By.XPATH, mensagem_verificar_xpath)))
            print(mensagem_verificar_element)
            mensagem_verificar = mensagem_verificar_element.text
            time.sleep(5)   
            print(f"mensagem_verificar: {mensagem_verificar}")
            print('conseguimos acessar a variavel mensagem_verificar')
            time.sleep(5)   


        
            botao_imprimir_final_xpath = '/html/body/div[29]/div[3]/div/button'
            botao_imprimir_final = WebDriverWait(driver, 50).until(EC.presence_of_element_located((By.XPATH, botao_imprimir_final_xpath)))
            
            #print(f"mensagem_verificar: {mensagem_verificar}")
            #time.sleep(2)
            print(f"mensagem_verificar: {mensagem_verificar}")
            print('Entramos no bloco de verificação')

            if 'Notas fiscais eletrônicas autorizadas com sucesso' in mensagem_verificar or 'Não há nada para ser feito' in mensagem_verificar:
                actions = ActionChains(driver)
                actions.move_to_element(botao_imprimir_final).click().perform()
                print('Sucesso na emissão')
                time.sleep(1)
                break  # Sai do loop se a condição for satisfeita

            elif 'Notas fiscais eletrônicas não foram validadas' in mensagem_verificar:
                print('Emissão não concluída')
                botao_erro_nota_xpath = '/html/body/div[28]/div[3]/div/button'
                botao_enviar_nota = WebDriverWait(driver, 50).until(EC.presence_of_element_located((By.XPATH, botao_erro_nota_xpath)))
                actions = ActionChains(driver)
                actions.move_to_element(botao_enviar_nota).click().perform()
                time.sleep(2)
                desmarcar_checkbox_atual(driver, index)
                return False, index +1
                
                # Você pode atualizar ou verificar a 'mensagem_verificar' novamente aqui
                #mensagem_verificar = driver.find_element(By.XPATH, "xpath_da_mensagem").text  # Supondo que você tenha um XPath para a mensagem
            else:
                print("Nenhuma das condições foi satisfeita, tentando novamente...")
                time.sleep(2)  # Espera um tempo antes de tentar novamente

#xpath pra encerrar a impressao /html/body/div[28]/div[3]/div/button
    except Exception as e:
            print(f"Erro ao validar envio: {e}") 
            
def funcao_erro_municipio(driver):
    #print(f'o index recebido é: {index}')
    try:
        print('executando alteracao de cadastro relacionada ao municipio')
        time.sleep(3)
        botao_editar_municipio_lapis_xpath = '/html/body/div[6]/div[2]/form/div/div/div[25]/div[1]/span/a[2]'
        botao_editar_municipio_lapis = WebDriverWait(driver, 50).until(EC.presence_of_element_located((By.XPATH, botao_editar_municipio_lapis_xpath)))             
        actions = ActionChains(driver)
        actions.move_to_element(botao_editar_municipio_lapis).click().perform()
        print(f'clicado botao de lupa endereço {botao_editar_municipio_lapis_xpath}')
        print('abrindo campo de cadastro do cliente')

        botao_lupa_cep_XPATH = '/html/body/div[28]/form/div[3]/div/div[1]/div/a/i'
        botao_lupa_cep = WebDriverWait(driver, 50).until(EC.element_to_be_clickable((By.XPATH, botao_lupa_cep_XPATH))) 
        actions = ActionChains(driver)
        time.sleep(2)
        actions.move_to_element(botao_lupa_cep).click().perform()
        print(f'clicado botao de lupa endereço {botao_lupa_cep_XPATH}')

        campo_bairro_xpath = '/html/body/div[28]/form/div[3]/div/div[4]/input'
        campo_bairro = WebDriverWait(driver, 50).until(EC.element_to_be_clickable((By.XPATH, campo_bairro_xpath)))
        ActionChains(driver).double_click( campo_bairro).perform()
        campo_bairro.clear()
        print('alterando campo bairro')
        time.sleep(1)
        campo_bairro.send_keys('s/n')

        campo_endereco_xpath = '/html/body/div[28]/form/div[3]/div/div[5]/input'
        campo_endereco = WebDriverWait(driver, 50).until(EC.element_to_be_clickable((By.XPATH, campo_endereco_xpath)))
        ActionChains(driver).double_click(campo_endereco).perform()
        time.sleep(1)
        campo_endereco.clear()
        time.sleep(1)
        print('alterando campo endereco')
        campo_endereco.send_keys('s/n')

        botao_salvar_novo_cadastro_XPATH = '/html/body/div[28]/div[2]/div/button'
        botao_salvar_novo_cadastro = WebDriverWait(driver, 50).until(EC.element_to_be_clickable((By.XPATH, botao_salvar_novo_cadastro_XPATH)))
        actions = ActionChains(driver)
        print('clique botao salvar alteracoes')
        time.sleep(3)
        actions.move_to_element(botao_salvar_novo_cadastro).click().perform()

        time.sleep(3)
        salvar_alteracoes_nota(driver)
        #print("Alterações na nota salvas com sucesso.")

        #return True

    except Exception as e:
        print(f"Erro na correção do município: {e}")
        return False  # Retorna False em caso de erro

def verificar_erro_salvamento(driver):
    try:
        time.sleep(1)
        print("Verificando mensagem de erro após salvar a nota...")
        mensagem_erro_xpath = '//*[@id="mensagem"]/p[1]'
        mensagem_erro = WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.XPATH, mensagem_erro_xpath))).text
        print(mensagem_erro)
        erro_especifico_xpath = '/html/body/div[6]/div[2]/form/div/div/div[3]/div/ul/li[1]'
        erro_especifico = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, erro_especifico_xpath))).text

        lista_erros.append(erro_especifico)
        
        if "Não foi possível salvar a Nota Fiscal" in mensagem_erro:
            print("Mensagem de erro detectada: Não foi possível salvar a Nota Fiscal")
            #erro_especifico_xpath = '/html/body/div[6]/div[2]/form/div/div/div[3]/div/ul/li[1]'
            #erro_especifico = WebDriverWait(driver, 50).until(
            #    EC.presence_of_element_located((By.XPATH, erro_especifico_xpath))
            #).text
            print(erro_especifico)
            
            # Verifica a presença de erros específicos relacionados ao município
            erros_municipio = ["O valor do campo município não foi encontrado no sistema", "UF válida"]
            if any(erro in erro_especifico for erro in erros_municipio):
                print('Erro específico no município encontrado.')
                funcao_erro_municipio(driver)
                return False  # Erro específico tratado no município
            
            # Se o erro não está relacionado ao município, mas existe um erro geral
            print('Erro encontrado, mas não é específico do município.')
            return True
        
        # Se não encontrar a string de erro principal
        print('Nenhuma mensagem de erro detectada após salvar a nota.')
        return False
        
    except Exception as e:
        print(f"Erro ao verificar mensagem de erro: {e}")#se der errado de verificara mensagem 
        return False

def cancelar_processo(driver):
    try:
        print("Tentando cancelar o processo...")
        botao_cancelar_xpath = '/html/body/div[6]/div[2]/form/div/div/div[1]/div/div[2]/button'
        botao_cancelar = WebDriverWait(driver, 50).until(
            EC.element_to_be_clickable((By.XPATH, botao_cancelar_xpath))
        )
        actions = ActionChains(driver)
        actions.move_to_element(botao_cancelar).click().perform()
        print("Processo cancelado.")
    except Exception as e:
        print(f"Erro ao cancelar o processo: {e}")

def existem_mais_notas_fiscais(driver, index):
    """
    Verifica se a nota fiscal na posição 'index' existe.
    Retorna True se a nota existir e False se não existir.
    """
    try:
        checkbox_xpath = f'/html/body/div[6]/div[8]/div[2]/div[7]/table/tbody/tr[{index}]/td[1]/div/label'
        WebDriverWait(driver, 50).until(
            EC.presence_of_element_located((By.XPATH, checkbox_xpath))
        )
        return True
    except:
        return False

def print_summary(success_count, error_count):
    print(f"Notas Fiscais emitidas com sucesso: {success_count}")
    print(f"Notas Fiscais com erros: {error_count}")

def main():
    driver = iniciar_driver()
    if driver is not None:
        driver.get("https://www.bling.com.br/notas.fiscais.php#list")  # Abrir a página específica
        success_count = 0
        error_count = 0
        index = 1
        notas_inexistentes_consecutivas = 0  # Contador de notas inexistentes consecutivas

        while True:
            try:
                # Verificar se a nota existe
                if not existem_mais_notas_fiscais(driver, index):
                    notas_inexistentes_consecutivas += 1
                    print(f"Nota fiscal {index} não encontrada. Notas inexistentes consecutivas: {notas_inexistentes_consecutivas}")
                    
                    # Se duas notas consecutivas não existirem, encerrar o script
                    if notas_inexistentes_consecutivas >= 2:
                        print("Duas notas consecutivas não existem. Encerrando o script.")
                        break
                    
                    index += 1  # Tentar a próxima nota
                    continue
                
                # Se a nota for encontrada e processada, resetar o contador de notas inexistentes
                notas_inexistentes_consecutivas = 0
                erro, proximo_index = processar_nota_fiscal(driver, index)
                
                if erro:
                    error_count += 1
                else:
                    success_count += 1
                
                index = proximo_index

            except Exception as e:
                print(f"Ocorreu um erro ao processar a nota fiscal {index}: {e}")
                error_count += 1
                index += 1
        
        print_summary(success_count, error_count)
        print( lista_erros)
        driver.quit()
        df = pd.DataFrame(lista_erros, success_count, error_count)
        df.to_excel('rel_erros_SHP.xlsx', index=False)
    else:
        print("Não foi possível iniciar o driver.")

if __name__ == "__main__":
    main()